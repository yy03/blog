<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>新闻垂直搜索系统 | YuanYE</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/blog/logo.png">
    <meta name="description" content="Kori Lin BLOG">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" conetent="KORILIN">
    <meta name="twitter:creator" conetent="@Kori_Lin">
    
    <link rel="preload" href="/blog/assets/css/1.styles.1f37ec6d.css" as="style"><link rel="preload" href="/blog/assets/js/app.3aaa0c49.js" as="script"><link rel="preload" href="/blog/assets/js/2.1e961ff5.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.73419e87.js"><link rel="prefetch" href="/blog/assets/js/11.05829631.js"><link rel="prefetch" href="/blog/assets/js/12.7e8086c5.js"><link rel="prefetch" href="/blog/assets/js/13.f1400667.js"><link rel="prefetch" href="/blog/assets/js/14.c6dd0951.js"><link rel="prefetch" href="/blog/assets/js/15.0f37c6f6.js"><link rel="prefetch" href="/blog/assets/js/16.a4662ec0.js"><link rel="prefetch" href="/blog/assets/js/17.e8372a64.js"><link rel="prefetch" href="/blog/assets/js/18.37715e79.js"><link rel="prefetch" href="/blog/assets/js/19.e397b51f.js"><link rel="prefetch" href="/blog/assets/js/20.19f61b49.js"><link rel="prefetch" href="/blog/assets/js/21.3b043514.js"><link rel="prefetch" href="/blog/assets/js/22.60b4227d.js"><link rel="prefetch" href="/blog/assets/js/23.0dbcd6f8.js"><link rel="prefetch" href="/blog/assets/js/24.b5bb6a2c.js"><link rel="prefetch" href="/blog/assets/js/25.f36cd997.js"><link rel="prefetch" href="/blog/assets/js/26.2173183c.js"><link rel="prefetch" href="/blog/assets/js/27.7e05cc7c.js"><link rel="prefetch" href="/blog/assets/js/28.bcba955e.js"><link rel="prefetch" href="/blog/assets/js/29.f0b4c45b.js"><link rel="prefetch" href="/blog/assets/js/3.58551e39.js"><link rel="prefetch" href="/blog/assets/js/30.04c3ed65.js"><link rel="prefetch" href="/blog/assets/js/4.bf1654a3.js"><link rel="prefetch" href="/blog/assets/js/5.cb45b255.js"><link rel="prefetch" href="/blog/assets/js/6.aa9fd703.js"><link rel="prefetch" href="/blog/assets/js/7.a807b0d2.js"><link rel="prefetch" href="/blog/assets/js/8.29c46423.js"><link rel="prefetch" href="/blog/assets/js/9.58f55c6f.js">
    <link rel="stylesheet" href="/blog/assets/css/1.styles.1f37ec6d.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><span><div id="sidebar" data-v-6e67c360><div class="PC-sidebar" data-v-6e67c360><div class="title" data-v-6e67c360>
            @<span data-v-6e67c360>YuanYE</span></div> <a href="/blog/" class="router-link-active bar-button" data-v-7201a518 data-v-6e67c360><div class="svg" data-v-7201a518><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-home" data-v-7201a518><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" data-v-7201a518></path> <polyline points="9 22 9 12 15 12 15 22" data-v-7201a518></polyline></svg> <!----> <!----></div> <div class="name" data-v-7201a518>Home</div></a> <a href="/blog/archive" class="bar-button" data-v-7201a518 data-v-6e67c360><div class="svg" data-v-7201a518><!----> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-book" data-v-7201a518><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" data-v-7201a518></path> <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" data-v-7201a518></path></svg> <!----></div> <div class="name" data-v-7201a518>Archive</div></a> <a href="/blog/about/" class="bar-button" data-v-7201a518 data-v-6e67c360><div class="svg" data-v-7201a518><!----> <!----> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user" data-v-7201a518><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" data-v-7201a518></path> <circle cx="12" cy="7" r="4" data-v-7201a518></circle></svg></div> <div class="name" data-v-7201a518>About</div></a></div> <!----></div><div class="main"><div class="wrap" data-v-5d573f62><div class="post" data-v-5d573f62><div class="title" data-v-5d573f62><h1 data-v-5d573f62>新闻垂直搜索系统</h1></div> <div class="info" data-v-5d573f62><div class="date" data-v-382026d3 data-v-5d573f62><div class="svg" data-v-382026d3><svg t="1610177893433" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5858" width="16" height="16" class="icon" data-v-382026d3><path d="M512 192c179.2 0 320 140.8 320 320s-140.8 320-320 320-320-140.8-320-320S332.8 192 512 192M512 128C300.8 128 128 300.8 128 512s172.8 384 384 384 384-172.8 384-384S723.2 128 512 128L512 128z" p-id="5859" fill="#707070" data-v-382026d3></path> <path d="M640 672c-6.4 0-19.2 0-25.6-6.4l-128-128C486.4 531.2 480 518.4 480 512L480 288C480 268.8 492.8 256 512 256s32 12.8 32 32l0 211.2 121.6 121.6c12.8 12.8 12.8 32 0 44.8C659.2 672 646.4 672 640 672z" p-id="5860" fill="#707070" data-v-382026d3></path></svg></div> <div class="content" data-v-382026d3>2022-5-7</div></div> <div class="category" data-v-a6fce850 data-v-5d573f62><div class="svg" data-v-a6fce850><svg t="1610177808699" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4460" width="16" height="16" class="icon" data-v-a6fce850><path d="M725.290667 725.290667m-213.333334 0a213.333333 213.333333 0 1 0 426.666667 0 213.333333 213.333333 0 1 0-426.666667 0Z" p-id="4461" fill="#707070" data-v-a6fce850></path> <path d="M789.205333 234.794667m-149.333333 0a149.333333 149.333333 0 1 0 298.666667 0 149.333333 149.333333 0 1 0-298.666667 0Z" p-id="4462" fill="#707070" data-v-a6fce850></path> <path d="M235.861333 788.138667m-149.333333 0a149.333333 149.333333 0 1 0 298.666667 0 149.333333 149.333333 0 1 0-298.666667 0Z" p-id="4463" fill="#707070" data-v-a6fce850></path> <path d="M298.709333 298.709333m-213.333333 0a213.333333 213.333333 0 1 0 426.666667 0 213.333333 213.333333 0 1 0-426.666667 0Z" p-id="4464" fill="#707070" data-v-a6fce850></path></svg></div> <div class="content" data-v-a6fce850>笔记</div></div> <div class="tags" data-v-2ed44237 data-v-5d573f62><div class="svg" data-v-2ed44237><svg t="1610177743508" viewBox="0 0 1085 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2934" width="16" height="16" class="icon" data-v-2ed44237><path d="M256 256q0-30.285714-21.428571-51.714286T182.857143 182.857143t-51.714286 21.428571T109.714286 256t21.428571 51.714286T182.857143 329.142857t51.714286-21.428571T256 256z m609.714286 329.142857q0 30.285714-21.142857 51.428572l-280.571429 281.142857q-22.285714 21.142857-52 21.142857-30.285714 0-51.428571-21.142857L52 508.571429q-21.714286-21.142857-36.857143-57.714286T0 384V146.285714q0-29.714286 21.714286-51.428571t51.428571-21.714286h237.714286q30.285714 0 66.857143 15.142857T436 125.142857l408.571429 408q21.142857 22.285714 21.142857 52z m219.428571 0q0 30.285714-21.142857 51.428572l-280.571429 281.142857q-22.285714 21.142857-52 21.142857-20.571429 0-33.714285-8t-30.285715-25.714286l268.571429-268.571428q21.142857-21.142857 21.142857-51.428572 0-29.714286-21.142857-52L527.428571 125.142857q-21.714286-21.714286-58.285714-36.857143T402.285714 73.142857h128q30.285714 0 66.857143 15.142857t58.285714 36.857143l408.571429 408q21.142857 22.285714 21.142857 52z" p-id="2935" fill="#8a8a8a" data-v-2ed44237></path></svg></div> <div class="content" data-v-2ed44237><span class="tag" style="color:#1DA1F2;" data-v-2ed44237>
            新闻垂直搜索系统
        </span></div></div></div> <div class="line" data-v-5d573f62></div> <div class="content" data-v-5d573f62><div class="content__default" data-v-5d573f62><p>==<strong>用户界面，就是参考的今日头条（PC端），简易版的，但是现在系统还没写好，界面效果比较少，系统功能点在要求以及本篇文章都会提及到</strong>==</p> <h2 id="_1-新闻的爬取"><a href="#_1-新闻的爬取" class="header-anchor">#</a> 1. 新闻的爬取</h2> <p>爬虫使用的框架是Scrapy，将爬取到的新闻存入到ElasticSearch中。</p> <p>在ElasticSearch中为新闻和标题设置为搜索的keyword并加入了中文分词（IK中文分词器），在首页搜索的时候，会从ES中新闻的标题或内容进行匹配，如果匹配就返回。</p> <ol><li>先准备要存入ES中的文章类型，构建ES的索引和文章属性</li></ol> <div class="language-python extra-class"><pre class="language-python"><code>
<span class="token keyword">from</span> elasticsearch_dsl <span class="token keyword">import</span> Document<span class="token punctuation">,</span>Nested<span class="token punctuation">,</span>Date<span class="token punctuation">,</span>Boolean<span class="token punctuation">,</span>analyzer<span class="token punctuation">,</span>Completion<span class="token punctuation">,</span>Text<span class="token punctuation">,</span>Keyword<span class="token punctuation">,</span>Integer
<span class="token keyword">from</span> elasticsearch_dsl <span class="token keyword">import</span> connections

connections<span class="token punctuation">.</span>create_connection<span class="token punctuation">(</span>hosts<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'192.168.18.101'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> timeout<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">)</span>
<span class="token keyword">class</span> <span class="token class-name">ArticleType</span><span class="token punctuation">(</span>Document<span class="token punctuation">)</span><span class="token punctuation">:</span>

    <span class="token comment"># 文章标题</span>
    title <span class="token operator">=</span> Text<span class="token punctuation">(</span>analyzer<span class="token operator">=</span><span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">)</span>
    <span class="token comment"># 发表时间</span>
    create_date <span class="token operator">=</span> Text<span class="token punctuation">(</span>analyzer<span class="token operator">=</span><span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">)</span>
    <span class="token comment"># 作者</span>
    author <span class="token operator">=</span> Text<span class="token punctuation">(</span>analyzer<span class="token operator">=</span><span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">)</span>
    <span class="token comment"># 新闻类型</span>
    tag <span class="token operator">=</span> Text<span class="token punctuation">(</span>analyzer<span class="token operator">=</span><span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">)</span>
    <span class="token comment"># 新闻内容</span>
    content <span class="token operator">=</span> Text<span class="token punctuation">(</span>analyzer<span class="token operator">=</span><span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">)</span>
    <span class="token comment"># 用户id，当前系统用户发表的新闻才记录用户id，便于查找某一个用户的新闻</span>
    userId <span class="token operator">=</span> Text<span class="token punctuation">(</span>analyzer<span class="token operator">=</span><span class="token string">&quot;ik_max_word&quot;</span><span class="token punctuation">)</span>


    <span class="token keyword">class</span> <span class="token class-name">Index</span><span class="token punctuation">:</span>
        <span class="token comment"># ES中索引名称</span>
        name <span class="token operator">=</span> <span class="token string">&quot;news&quot;</span>

<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    ArticleType<span class="token punctuation">.</span>init<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ol start="2"><li>创建Scrapy中要使用到的Item，就是当爬取完新闻并进行解析之后，存入到Item中，步骤三与步骤四会用到</li></ol> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> scrapy


<span class="token keyword">class</span> <span class="token class-name">NewsItem</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Item<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># define the fields for your item here like:</span>
    <span class="token comment"># name = scrapy.Field()</span>
    title <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    createTime <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    content <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
    author <span class="token operator">=</span> scrapy<span class="token punctuation">.</span>Field<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre></div><ol start="3"><li>创建Scrapy与ElasticSearch的保存文章的通道</li></ol> <div class="language-pyt extra-class"><pre class="language-text"><code>
from crawlnews.new_es import ArticleType


class CrawlnewsPipeline:
    def process_item(self, item, spider):
        article = ArticleType()

        article.title = item['title']
        article.create_date = item['createTime']
        article.author = item['author']
        article.tag = &quot;sport&quot;
        article.content = item['content']

        article.save()
        return item
</code></pre></div><ol start="4"><li>准备工作完成之后，进行新闻的爬取</li></ol> <div class="language-python extra-class"><pre class="language-python"><code><span class="token keyword">import</span> scrapy

<span class="token keyword">from</span> crawlnews<span class="token punctuation">.</span>items <span class="token keyword">import</span> NewsItem


<span class="token keyword">class</span> <span class="token class-name">TencentSpider</span><span class="token punctuation">(</span>scrapy<span class="token punctuation">.</span>Spider<span class="token punctuation">)</span><span class="token punctuation">:</span>
    name <span class="token operator">=</span> <span class="token string">'tencent'</span>
    allowed_domains <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'sina.com.cn'</span><span class="token punctuation">]</span>
    <span class="token comment"># 爬取新闻网站的初始地址，这个是新浪新闻的体育分类下的新闻</span>
    start_urls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'https://sports.sina.com.cn/nba/'</span><span class="token punctuation">]</span>

    <span class="token keyword">def</span> <span class="token function">parse</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> response<span class="token punctuation">.</span>url<span class="token operator">==</span><span class="token string">'https://sports.sina.com.cn/nba/'</span><span class="token punctuation">:</span>
            urls <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//li[@class=&quot;item&quot;]//a/@href'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract<span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">for</span> url <span class="token keyword">in</span> urls<span class="token punctuation">:</span>
                <span class="token keyword">print</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span>
                <span class="token keyword">yield</span> scrapy<span class="token punctuation">.</span>Request<span class="token punctuation">(</span>url<span class="token punctuation">,</span> self<span class="token punctuation">.</span>parse<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token comment"># 进行标签解析之后获得新闻的标题等数据，存入NewsItem中，然后步骤三执行，获取到NewsItem存入ES中</span>
           title <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'/html/body/div[2]/h1/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
           createTime <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//*[@id=&quot;top_bar&quot;]/div/div[2]/span/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
           author <span class="token operator">=</span> response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//*[@id=&quot;top_bar&quot;]/div/div[2]/a/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract_first<span class="token punctuation">(</span><span class="token punctuation">)</span>
           content <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>response<span class="token punctuation">.</span>xpath<span class="token punctuation">(</span><span class="token string">'//*[@id=&quot;artibody&quot;]/p/text()'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>extract<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

           item <span class="token operator">=</span> NewsItem<span class="token punctuation">(</span><span class="token punctuation">)</span>
           item<span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span> <span class="token operator">=</span> title
           item<span class="token punctuation">[</span><span class="token string">'createTime'</span><span class="token punctuation">]</span> <span class="token operator">=</span> createTime
           item<span class="token punctuation">[</span><span class="token string">'author'</span><span class="token punctuation">]</span> <span class="token operator">=</span> author
           item<span class="token punctuation">[</span><span class="token string">'content'</span><span class="token punctuation">]</span> <span class="token operator">=</span> content
           <span class="token keyword">yield</span> item
</code></pre></div><h2 id="_2-用户界面"><a href="#_2-用户界面" class="header-anchor">#</a> 2 用户界面</h2> <p>用户界面就是基于VUE+Element-UI</p> <p><img src="/blog/assets/img/image-20220507122306824.d30195b0.png" alt="image-20220507122306824"></p> <h3 id="_2-1-登录-注册"><a href="#_2-1-登录-注册" class="header-anchor">#</a> 2.1 登录/注册</h3> <h4 id="注册"><a href="#注册" class="header-anchor">#</a> <strong>注册</strong></h4> <p><img src="/blog/assets/img/image-20220507122710590.92129f10.png" alt="image-20220507122710590"></p> <p>注册的时候，要发送邮箱验证码，后端Controller接收邮箱，先用email做为key从redis查找，如果redis中有值，不进行任何处理，redis中没值，rocketmq生产者发送消息到消费者。</p> <p><strong>后端接口及生产者发送消息：</strong></p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span> <span class="token punctuation">(</span><span class="token string">&quot;/sendCode&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendCode</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> email<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        sendCodeService<span class="token punctuation">.</span><span class="token function">sendcode</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// SendCodeService</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">sendcode</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            rocketMQTemplate<span class="token punctuation">.</span><span class="token function">convertAndSend</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span><span class="token class-name">MessageBuilder</span><span class="token punctuation">.</span><span class="token function">withPayload</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><p><strong>消费者</strong></p> <p>监听topic为code的消息队列，拿到email，随机生成六位数字，以email为key，验证码为value存入redis，有效期五分钟。并使用JavamailSender向邮箱发送邮件。</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@RocketMQMessageListener</span><span class="token punctuation">(</span>consumerGroup <span class="token operator">=</span> <span class="token string">&quot;codegroup&quot;</span><span class="token punctuation">,</span> topic <span class="token operator">=</span> <span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CodeConsumer</span> <span class="token keyword">implements</span> <span class="token class-name">RocketMQListener</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MessageExt</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">RedisTemplate</span> redisTemplate<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">JavaMailSender</span> javaMailSender<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">MailProperties</span> mailProperties<span class="token punctuation">;</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">sendMail</span><span class="token punctuation">(</span><span class="token class-name">String</span> email<span class="token punctuation">,</span> <span class="token class-name">String</span> code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">MimeMessage</span> mimeMessage <span class="token operator">=</span> javaMailSender<span class="token punctuation">.</span><span class="token function">createMimeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">MimeMessageHelper</span> mimeMessageHelper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MimeMessageHelper</span><span class="token punctuation">(</span>mimeMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            mimeMessageHelper<span class="token punctuation">.</span><span class="token function">setFrom</span><span class="token punctuation">(</span>mailProperties<span class="token punctuation">.</span><span class="token function">getUsername</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mimeMessageHelper<span class="token punctuation">.</span><span class="token function">setTo</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">;</span>
            mimeMessageHelper<span class="token punctuation">.</span><span class="token function">setSubject</span><span class="token punctuation">(</span><span class="token string">&quot;Vertical-Search&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            mimeMessage<span class="token punctuation">.</span><span class="token function">setText</span><span class="token punctuation">(</span><span class="token string">&quot;【Vertical-Search】验证码：&quot;</span> <span class="token operator">+</span> code <span class="token operator">+</span> <span class="token string">&quot;，有效期5分钟&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            javaMailSender<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>mimeMessageHelper<span class="token punctuation">.</span><span class="token function">getMimeMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">MessagingException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token class-name">MessageExt</span> message<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>message<span class="token punctuation">.</span><span class="token function">getBody</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span> map <span class="token operator">=</span> <span class="token class-name">JSONObject</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> email <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;payload&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">CharSequence</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>email<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> code <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">ThreadLocalRandom</span><span class="token punctuation">.</span><span class="token function">current</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token number">100000</span><span class="token punctuation">,</span> <span class="token number">1000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;验证码：{}&quot;</span><span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//            rocketMQTemplate.convertAndSend(&quot;code&quot;, MessageBuilder.withPayload(code).build());</span>
            redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span>code<span class="token punctuation">,</span><span class="token number">60</span> <span class="token operator">*</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span>SECONDS<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendMail</span><span class="token punctuation">(</span>email<span class="token punctuation">,</span> code<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>注册接口</strong></p> <p>代码还没写好</p> <p>思路：先判断验证码是否正确，如果正确，判断该邮箱是否注册过，都通过再进行注册；若不通过给相应提示（例如：该账号已存在），页面还没加提示。</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">register</span><span class="token punctuation">(</span><span class="token class-name">UserRegisterDto</span> userRegisterDto<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> needCode <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> redisTemplate<span class="token punctuation">.</span><span class="token function">opsForValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>userRegisterDto<span class="token punctuation">.</span><span class="token function">getEmail</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>needCode<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;验证码已失效！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>needCode<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>userRegisterDto<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;验证码不正确，请输入正确的验证码！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;注册成功！&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="登录"><a href="#登录" class="header-anchor">#</a> 登录</h4> <p><img src="/blog/assets/img/image-20220507153204746.7ebfa713.png" alt="image-20220507153204746"></p> <p>思路：普通登录逻辑，没有权限判断。</p> <h4 id="新闻列表"><a href="#新闻列表" class="header-anchor">#</a> 新闻列表</h4> <p><img src="/blog/assets/img/image-20220507153628798.8bb864b4.png" alt="image-20220507153628798"></p> <p>可以通过新闻分类获取不同类别下的新闻，获取新闻的代码如下：</p> <p>就是从es中获取</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/pageSearch&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">News</span><span class="token punctuation">&gt;</span></span> <span class="token function">queryPage</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>defaultValue <span class="token operator">=</span> <span class="token string">&quot;1&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> pageNum<span class="token punctuation">,</span> <span class="token annotation punctuation">@RequestParam</span><span class="token punctuation">(</span>defaultValue <span class="token operator">=</span> <span class="token string">&quot;10&quot;</span><span class="token punctuation">)</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">NativeSearchQuery</span> query <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NativeSearchQuery</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BoolQueryBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        query<span class="token punctuation">.</span><span class="token function">setPageable</span><span class="token punctuation">(</span><span class="token class-name">PageRequest</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>pageNum<span class="token punctuation">,</span> pageSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">SearchHits</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">News</span><span class="token punctuation">&gt;</span></span> search <span class="token operator">=</span> elasticsearchRestTemplate<span class="token punctuation">.</span><span class="token function">search</span><span class="token punctuation">(</span>query<span class="token punctuation">,</span> <span class="token class-name">News</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">News</span><span class="token punctuation">&gt;</span></span> collect <span class="token operator">=</span> search<span class="token punctuation">.</span><span class="token function">getSearchHits</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">SearchHit</span><span class="token operator">::</span><span class="token function">getContent</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">News</span><span class="token punctuation">&gt;</span></span> newsList <span class="token operator">=</span> collect<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>news <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> news<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> newsList<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre></div><h4 id="新闻详情页"><a href="#新闻详情页" class="header-anchor">#</a> 新闻详情页</h4> <p>在新闻列表中点击新闻的标题或者，进入<strong>新闻详情页</strong>，如果是点击作者名称则是进入<strong>作者详情页</strong>，也可以在<strong>新闻详情页</strong>中点击作者头像或名称进入<strong>作者详情页</strong></p> <p><img src="/blog/assets/img/image-20220507154952826.80d9e308.png" alt="image-20220507154952826"></p> <p>前端代码：</p> <p>新闻列表跳转到新闻详情页时，会传入id，拿到id请求后端接口，接受数据渲染页面：</p> <div class="language-vue extra-class"><pre class="language-vue"><code>    init() {
      this.axios.get(`/index/get?id=${this.id}`).then(res =&gt; {
        if (res.status == 200) {
          this.news = res.data
          let str = this.news.content
          str.replace(/\ +/g,&quot;<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>br</span><span class="token punctuation">/&gt;</span></span>&quot;)
          console.log(str)
          this.news.content = str
        }
      })
    },
</code></pre></div><p>后端：</p> <div class="language-java extra-class"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/get&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">News</span> <span class="token function">getNews</span><span class="token punctuation">(</span><span class="token annotation punctuation">@RequestParam</span> <span class="token class-name">String</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">News</span><span class="token punctuation">&gt;</span></span> news <span class="token operator">=</span> esService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> news<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre></div><h4 id="点赞-举报"><a href="#点赞-举报" class="header-anchor">#</a> 点赞/举报</h4> <p><img src="/blog/assets/img/image-20220507155235297.b000721b.png" alt="image-20220507155235297"></p> <p><img src="/blog/assets/img/image-20220507155435633.ab536ce3.png" alt="image-20220507155435633"></p> <p>数据库：</p> <div class="language-sql extra-class"><pre class="language-sql"><code>
<span class="token comment"># 新闻表，MySQL数据库中存的数据有新闻的id，与ES中的对应，评论数量和点赞数量</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>news<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>authorId<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'作者id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>commentCount<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'评论数量'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>likeCount<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'点赞数量'</span><span class="token punctuation">,</span>
   <span class="token punctuation">`</span>readCount<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'阅读数量'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre></div><div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment"># 举报记录表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>touristrecord<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'举报记录id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>userid<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'举报者id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>tour_content<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'举报内容'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>tour_type<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'举报类别id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>tour_id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'被举报id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>tour_detailType<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'被举报详情类型 1 用户 2 新闻 3评论'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>isSolve<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'是否处理'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>tour_datetime<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'举报时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre></div><p>思路：点赞/举报功能还没完成，</p> <ul><li>点赞：更改数据库中该新闻点赞数量（评论数量也是如此）</li> <li>举报：记录的信息如上图，当举报后，管理员要在管理端（还没页面）处理时可以根据是否处理和举报时间进行查找</li></ul> <h4 id="评论"><a href="#评论" class="header-anchor">#</a> 评论</h4> <p><img src="/blog/assets/img/image-20220507160146237.548bc768.png" alt="image-20220507160146237"></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment"># 评论表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span><span class="token keyword">comment</span><span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'评论id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>userId<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>newsId<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'新闻id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>parentId<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'父评论id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>toUserId<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'被回复userid'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token keyword">comment</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'评论内容'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>likeCount<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token string">'0'</span> <span class="token keyword">COMMENT</span> <span class="token string">'点赞数量'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>co_datetime<span class="token punctuation">`</span> <span class="token keyword">datetime</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'评论时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre></div><p>思路：评论时，记录内容如上表。当进入新闻详情页面时，通过新闻id在该表中获取全部评论</p> <h4 id="用户详情页"><a href="#用户详情页" class="header-anchor">#</a> 用户详情页</h4> <p>个人详情页与查看其他用户详情页内容一致，不同点在于个人详情页没有”关注“按钮</p> <p><img src="/blog/assets/img/image-20220507161447467.e1b47646.png" alt="image-20220507161447467"></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment"># 关注表，用来获得关注和粉丝</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>follow<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'关注id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>userId<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>followId<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'被关注者id'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre></div><ul><li><p>搜索：能够在用户详情页进行新闻搜索，思路：获得该新闻作者的userid与搜索关键词，以&amp;在ES中查找。</p></li> <li><p>关注功能：只有登录的用户才可以对新闻作者进行关注，当用户关注的作者发表新文章时，在首页会有小红点提示。</p></li></ul> <p><img src="/blog/assets/img/image-20220507163854400.686905c7.png" alt="image-20220507163854400"></p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment"># 订阅表，用来记录关注的作者发表的新闻，粉丝是否已读，当在首页切换到”关注“页签时，会从该表中获得当前用户未读的新闻id，并从es中获得</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>subscribe<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>id<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>userId<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'粉丝id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>newsId<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'新闻id'</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>isRead<span class="token punctuation">`</span> <span class="token keyword">tinyint</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'是否已读'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre></div><p><strong>实现思路：</strong></p> <p><strong>后端：当用户发表新闻时，除了将新闻存入ES之外，还要通过RocketMQ发送一条消息（引入Rocketmq的目的就是系统间的解耦），消息的内容是用户id和新闻id，RocketMQ的消费者拿到这个消息的时候，取出用户id和新闻id，通过用户id查找当前用户的所有粉丝的userid，与newsId一起存入上表中</strong></p> <p><strong>前端：前端页面显示小红点的思路，通过定时调用后端接口，后端接口就是从上表中查找自己未读的新闻id，如果没有就不显示小红点，如果有值，后端接口会将userId为key，List<NewsId>为value存入redis，减小数据库压力，并且前端显示小红点，当用户在主页切换到”关注“页签时，先从Redis中获取未读的新闻列表，然后再从ES中获取新闻。</NewsId></strong></p> <p><strong>其他：当用户切换到”关注“页签后，小红点不再显示，并且将未读的新闻全部更改为已读，并且删除redis中的数据。就是只要切换到”关注“页签，就默认当前”关注“页签下的新闻全部已读</strong></p> <ul><li><p>查看关注和粉丝</p> <p><img src="/blog/assets/img/image-20220507172942750.2efa0ed9.png" alt="image-20220507172942750"></p> <p>侧边栏出现用户信息，点击头像也可以进入用户详情页，也可以关注。</p></li> <li><p>近期最热文章</p></li></ul> <p><img src="/blog/assets/img/image-20220507173159211.1a7c1c5f.png" alt="image-20220507173159211"></p> <p>通过阅读量进行排序，从高到底</p> <h4 id="发表文章"><a href="#发表文章" class="header-anchor">#</a> 发表文章</h4> <p><img src="/blog/assets/img/image-20220507172242061.232a7617.png" alt="image-20220507172242061"></p> <p>点击<strong>个人详情</strong>进入用户详情页，点击<strong>发表文章</strong>进入以下界面，点击<strong>发表文章按钮</strong>后将用户id，新闻id存入MySQL中，其他信息存入ES</p> <p><img src="/blog/assets/img/image-20220507172539681.026e9d5f.png" alt="image-20220507172539681"></p> <h4 id="实时热榜"><a href="#实时热榜" class="header-anchor">#</a> 实时热榜</h4> <p><img src="/blog/assets/img/image-20220507173247904.e3d192ba.png" alt="image-20220507173247904"></p> <p>将用户搜索的内容通过redis的Zset进行排序。</p> <h3 id="_3-后端管理"><a href="#_3-后端管理" class="header-anchor">#</a> 3. 后端管理</h3> <p>后端管理目前还没做页面，就是和普通的管理端一样。</p> <p>功能如下：</p> <ul><li>用户管理：界面效果是，获取所有用户进行分页，列表上能够通过用户名搜索，行按钮能够对某一个用户封禁与解封禁，</li> <li>新闻管理：与用户管理界面效果一样，行按钮能够对新闻封禁与解封禁</li> <li>举报处理：界面效果与上一样，能够通过日期、举报人、进行搜索，处理举报</li></ul></div></div> <div class="footer" data-v-5d573f62><div title="share this post" class="share share-icon" data-v-5d573f62><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-share-2" data-v-5d573f62><circle cx="18" cy="5" r="3" data-v-5d573f62></circle><circle cx="6" cy="12" r="3" data-v-5d573f62></circle><circle cx="18" cy="19" r="3" data-v-5d573f62></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49" data-v-5d573f62></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49" data-v-5d573f62></line></svg> <path d="M896 469.333333l-298.666667-298.666667 0 170.666667C298.666667 384 170.666667 597.333333 128 810.666667c106.666667-149.333333 256-217.6 469.333333-217.6L597.333333 768 896 469.333333z" p-id="7022" fill="#1296db" data-v-5d573f62></path></div> <div class="share" data-v-5d573f62><!----></div> <div class="share" data-v-5d573f62><!----></div></div></div> <div class="footer" data-v-882df4f6 data-v-5d573f62><footer data-v-882df4f6><div data-v-882df4f6>
            © 2018 -
            2022
            <svg viewBox="64 64 896 896" data-icon="flag" width="1em" height="1em" fill="currentColor" aria-hidden="true" focusable="false" data-v-882df4f6><path fill="#1296db" d="M880 305H624V192c0-17.7-14.3-32-32-32H184v-40c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v784c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8V640h248v113c0 17.7 14.3 32 32 32h416c17.7 0 32-14.3 32-32V337c0-17.7-14.3-32-32-32z" data-v-882df4f6></path></svg>
            @Yuan YE
        </div> <div data-v-882df4f6>
            Based on the
            <a href="https://vuepress.vuejs.org/" target="_blank" data-v-882df4f6>VuePress Powered</a>
            &amp;
            <a href="https://github.com/korilin/vuepress-theme-twipress" target="_blank" data-v-882df4f6>Twipress Theme</a></div> <div data-v-882df4f6>
            备案号：<a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/" data-v-882df4f6>
                粤ICP备19149652号
            </a></div></footer></div></div></div><div id="toolbar" data-v-fe84d7a0><!----> <div class="toolbar" data-v-fe84d7a0><div class="search" data-v-fe84d7a0><div class="search-box" data-v-fe84d7a0><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div> <div class="post-sort" data-v-fe84d7a0><div class="title" data-v-fe84d7a0>Post Order</div> <div class="op" data-v-fe84d7a0>
                By Time
                <svg t="1610607067172" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2795" width="20" height="20" class="icon" style="display:;" data-v-fe84d7a0><path d="M495.765247 353.091804 333.414649 190.741205 171.065074 353.091804 304.386522 353.091804l0 420.142919c0 17.947767 14.046924 32.469506 31.978319 32.469506 17.931395 0 31.978319-14.522762 31.978319-32.469506L368.343159 353.091804 495.765247 353.091804z" p-id="2796" data-v-fe84d7a0></path> <path d="M720.104665 672.874991 720.104665 221.24494c0-17.947767-14.046924-32.469506-31.978319-32.469506s-31.978319 14.522762-31.978319 32.469506l0 451.630051-127.913275 0 162.349575 162.349575 162.349575-162.349575L720.104665 672.874991z" p-id="2797" data-spm-anchor-id="a313x.7781069.0.i7" fill="#1296db" class="selected" data-v-fe84d7a0></path></svg> <svg t="1610612746140" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2973" width="20" height="20" class="icon" style="display:none;" data-v-fe84d7a0><path d="M495.765247 353.091804 333.414649 190.741205 171.065074 353.091804 304.386522 353.091804l0 420.142919c0 17.947767 14.046924 32.469506 31.978319 32.469506 17.931395 0 31.978319-14.522762 31.978319-32.469506L368.343159 353.091804 495.765247 353.091804z" p-id="2974" data-spm-anchor-id="a313x.7781069.0.i9" fill="#1296db" class="selected" data-v-fe84d7a0></path> <path d="M720.104665 672.874991 720.104665 221.24494c0-17.947767-14.046924-32.469506-31.978319-32.469506s-31.978319 14.522762-31.978319 32.469506l0 451.630051-127.913275 0 162.349575 162.349575 162.349575-162.349575L720.104665 672.874991z" p-id="2975" data-v-fe84d7a0></path></svg>
                :
                <span class="content" data-v-fe84d7a0>DESC</span></div></div> <div class="statistics" data-v-fe84d7a0><div class="title" data-v-fe84d7a0>Article Statistics</div> <div class="data" data-v-fe84d7a0>
                Article: 27
            </div> <div class="data" data-v-fe84d7a0>
                Categories: 5
            </div> <div class="data" data-v-fe84d7a0>
                Tags: 18
            </div> <div class="more" data-v-fe84d7a0><a href="/blog/archive" data-v-fe84d7a0>see more</a></div></div></div></div></span></div><div class="global-ui"></div></div>
    <script src="/blog/assets/js/app.3aaa0c49.js" defer></script><script src="/blog/assets/js/2.1e961ff5.js" defer></script>
  </body>
</html>
